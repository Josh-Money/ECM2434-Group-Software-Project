{% extends 'base.html' %}
{% load static %}

{% block title %}{{ article.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'articles/css/articles-styles.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="title">{{ article.title }}</h1>
    <p class="published-date">Published: {{ article.published_date|date:"F j, Y" }}</p>
    
    <div class="article-content">
        {% if article.url %}
            <p>Read the full article at: <a href="{{ article.url }}" target="_blank">{{ article.url }}</a></p>
        {% endif %}
        
        {{ article.content|linebreaks }}
    </div>
    
    {% if quiz %}
        <div class="quiz-section">
            <button id="toggleQuiz" class="btn btn-primary w-25">{{ quiz.title }} ⬇</button>
            <div id="quizContainer" class="hidden">
                <h6 class="subtitle2"><strong>{{ quiz.title }}</strong></h6>
                <input type="hidden" id="quiz-id" value="{{ quiz.id }}">
                
                {% for question in questions %}
                    <p class="subtitle question">Question {{ question.order }}</p>
                    <p>{{ question.text }}</p>
                    <label class="truefalse">
                        <input type="radio" name="Q{{ question.id }}" value="true" /> True
                    </label>
                    <label class="truefalse">
                        <input type="radio" name="Q{{ question.id }}" value="false" /> False
                    </label>
                {% endfor %}
                
                <button id="checkAnswer" class="btn btn-primary w-80">Check Answers</button>
                <p id="feedback"></p>
            </div>
        </div>
    {% endif %}
    
    <a href="{% url 'articles' %}" class="btn btn-secondary mt-3">Back to Articles</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Toggle quiz visibility
    const toggleQuizBtn = document.getElementById("toggleQuiz");
    if (toggleQuizBtn) {
        toggleQuizBtn.addEventListener("click", function () {
            const quizContainer = document.getElementById("quizContainer");
            if (quizContainer.style.display === "none" || quizContainer.classList.contains("hidden")) {
                quizContainer.style.display = "block";
                this.textContent = "{{ quiz.title }} ⬆"; 
            } else {
                quizContainer.style.display = "none";
                this.textContent = "{{ quiz.title }} ⬇"; 
            }
            quizContainer.classList.toggle("hidden");
        });
    }

    // Check answers functionality
    const checkAnswerBtn = document.getElementById("checkAnswer");
    if (checkAnswerBtn) {
        checkAnswerBtn.addEventListener("click", function () {
            let score = 0;
            let totalQuestions = 0;
            
            // Get all questions
            const questions = document.querySelectorAll(".question");
            totalQuestions = questions.length;
            
            // Check each question's answer
            {% for question in questions %}
            const selectedOption{{ question.id }} = document.querySelector('input[name="Q{{ question.id }}"]:checked');
            const feedback{{ question.id }} = document.createElement("span");
            feedback{{ question.id }}.id = "feedback-{{ question.id }}";
            feedback{{ question.id }}.style.marginLeft = "10px";
            
            if (selectedOption{{ question.id }}) {
                if (selectedOption{{ question.id }}.value === "{{ question.correct_answer }}") {
                    feedback{{ question.id }}.textContent = "✅ Correct";
                    feedback{{ question.id }}.style.color = "green";
                    score++;
                } else {
                    feedback{{ question.id }}.textContent = "❌ Incorrect";
                    feedback{{ question.id }}.style.color = "red";
                }
            } else {
                feedback{{ question.id }}.textContent = "⚠️ Please select an option!";
                feedback{{ question.id }}.style.color = "orange";
            }
            
            // Append feedback next to the question
            const lastRadio{{ question.id }} = document.querySelectorAll('input[name="Q{{ question.id }}"]');
            if (lastRadio{{ question.id }}.length > 0) {
                lastRadio{{ question.id }}[lastRadio{{ question.id }}.length - 1].parentNode.appendChild(feedback{{ question.id }});
            }
            {% endfor %}
            
            // Display score
            let scoreDisplay = document.getElementById("scoreDisplay");
            if (!scoreDisplay) {
                scoreDisplay = document.createElement("span");
                scoreDisplay.id = "scoreDisplay";
                scoreDisplay.style.marginLeft = "15px";
                document.getElementById("checkAnswer").after(scoreDisplay);
            }
            
            const pointsPerQuestion = {{ quiz.points_per_question }};
            const totalPoints = score * pointsPerQuestion;
            scoreDisplay.textContent = ` Score: ${score}/${totalQuestions}. You earned ${totalPoints} points!`;
            scoreDisplay.style.fontWeight = "bold";
            
            // Disable inputs and button after submission
            document.querySelectorAll('input[type="radio"]').forEach(input => {
                input.disabled = true;
            });
            document.getElementById("checkAnswer").disabled = true;
            
            // Submit score to server
            fetch('{% url "articles" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new URLSearchParams({
                    'quiz_id': document.getElementById("quiz-id").value,
                    'correct_answers': score
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                return response.json();
            })
            .then(data => {
                console.log("Leaderboard updated:", data);
            })
            .catch(error => console.error("Error updating leaderboard:", error));
        });
    }
});
</script>
{% endblock %} 